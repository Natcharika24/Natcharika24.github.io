<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Train Tracker | Chiang Mai to Phitsanulok</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0b0b0b;
            font-family: 'Outfit', 'Prompt', sans-serif;
            color: white;
        }

        #overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(18, 18, 18, 0.85);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #8b5cf6;
            backdrop-filter: blur(5px);
        }

        h2 {
            margin: 0 0 10px 0;
            color: #8b5cf6;
            font-family: 'Outfit', sans-serif;
        }

        #footer {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            z-index: 10;
            font-size: 0.85rem;
            color: #888;
            font-family: 'Outfit';
            pointer-events: none;
        }

        #infoBox {
            display: none;
            position: absolute;
            background: rgba(30, 30, 30, 0.9);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            pointer-events: none;
            z-index: 20;
            transform: translate(15px, -50%);
        }
    </style>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=Prompt:wght@300;400;500&display=swap"
        rel="stylesheet">
</head>

<body>
    <div id="overlay">
        <h2>üöÇ 3D Train Tracker</h2>
        <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á...</div>
        <div id="progress" style="margin-top: 10px; color: #bbb;">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <span id="percent"
                style="color: #fff; font-weight: bold;">0</span>%</div>
        <div style="margin-top: 15px; font-size: 0.8rem; color: #666;">* ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ñ‡∏•‡∏¥‡∏Å/‡∏ã‡∏π‡∏°/‡∏´‡∏°‡∏∏‡∏ô‡∏î‡∏π‡∏£‡∏≠‡∏ö‡πÜ ‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞
        </div>
    </div>

    <div id="infoBox"></div>
    <div id="footer">Generated by <strong>Antigravity Oracle</strong> | <em>"The Oracle Keeps the Human Human"</em>
    </div>

    <!-- Three.js and add-ons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // Setup Three.js Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0b0b0b);
        scene.fog = new THREE.FogExp2(0x0b0b0b, 0.005);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.05; // Prevent camera from going below ground

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(100, 200, 50);
        scene.add(dirLight);

        // Grid helper
        const gridHelper = new THREE.GridHelper(300, 60, 0x333333, 0x111111);
        gridHelper.position.y = -0.1;
        scene.add(gridHelper);

        // Train Group (Geometry)
        const train = new THREE.Group();

        // Engine body (Purple)
        const bodyGeo = new THREE.BoxGeometry(2, 2.5, 5);
        const bodyMat = new THREE.MeshPhongMaterial({ color: 0x8b5cf6, flatShading: true });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        body.position.y = 1.25;
        train.add(body);

        // Cabin (Blue)
        const cabinGeo = new THREE.BoxGeometry(2.2, 3, 2);
        const cabinMat = new THREE.MeshPhongMaterial({ color: 0x3b82f6, flatShading: true });
        const cabin = new THREE.Mesh(cabinGeo, cabinMat);
        cabin.position.set(0, 1.5, -1.5);
        train.add(cabin);

        // Smoke stack (Grey)
        const stackGeo = new THREE.CylinderGeometry(0.3, 0.5, 1.5);
        const stackMat = new THREE.MeshPhongMaterial({ color: 0xaaaaaa });
        const stack = new THREE.Mesh(stackGeo, stackMat);
        stack.position.set(0, 3, 1.5);
        train.add(stack);

        scene.add(train);

        // Data Variables
        let curve = null;
        let pointsData = [];
        let animationProgress = 0;
        const animationSpeed = 0.0005; // Speed of the train

        // Fetch Data
        const csvUrl = "./travel-phitsanulok.csv";

        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                document.getElementById('status').innerHTML = '<span style="color:#10b981">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (' + results.data.length + ' ‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î)</span>';
                processData(results.data);
            }
        });

        function processData(data) {
            const sorted = data.sort((a, b) => new Date(a.updated) - new Date(b.updated));
            const vecs = [];

            // Calculate center
            let minLat = 90, maxLat = -90, minLon = 180, maxLon = -180;
            sorted.forEach(row => {
                const lat = parseFloat(row.lat);
                const lon = parseFloat(row.lon);
                if (!isNaN(lat) && !isNaN(lon)) {
                    if (lat < minLat) minLat = lat;
                    if (lat > maxLat) maxLat = lat;
                    if (lon < minLon) minLon = lon;
                    if (lon > maxLon) maxLon = lon;
                }
            });

            const centerLat = (minLat + maxLat) / 2;
            const centerLon = (minLon + maxLon) / 2;

            // Scale factor to map lat/lon into 3D units comfortably
            const scale = 50;

            sorted.forEach(row => {
                const lat = parseFloat(row.lat);
                const lon = parseFloat(row.lon);

                if (!isNaN(lat) && !isNaN(lon)) {
                    // Map lat/lon to X/Z coordinates. Y is up.
                    const x = (lon - centerLon) * scale;
                    // Invert lat so North is -Z (matching standard 3D coordinate mapping)
                    const z = -(lat - centerLat) * scale;
                    const y = 0;

                    const vec = new THREE.Vector3(x, y, z);

                    // Filter out duplicate identical points for smoother curve
                    if (vecs.length > 0) {
                        const lastVec = vecs[vecs.length - 1];
                        if (vec.distanceTo(lastVec) < 0.1) return; // Skip too close points
                    }

                    vecs.push(vec);
                }
            });

            if (vecs.length < 2) return;

            // Create Path Curve
            curve = new THREE.CatmullRomCurve3(vecs);

            // Draw Track Line
            const points = curve.getPoints(vecs.length * 10);
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: 0x3b82f6, linewidth: 3, opacity: 0.6, transparent: true });
            const trackLine = new THREE.Line(geometry, material);
            scene.add(trackLine);

            // Draw Waypoint Orbs
            const orbGeo = new THREE.IcosahedronGeometry(0.3, 0);
            const orbMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
            vecs.forEach(v => {
                const orb = new THREE.Mesh(orbGeo, orbMat);
                orb.position.copy(v);
                scene.add(orb);
            });

            // Init Camera looking at start
            const startPt = curve.getPointAt(0);
            camera.position.set(startPt.x + 20, startPt.y + 15, startPt.z + 20);
            controls.target.copy(startPt);

            // Start Animation Loop
            animate();
        }

        const percentSpan = document.getElementById('percent');

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);

            if (curve) {
                // Move Train along the curve
                animationProgress += animationSpeed;
                if (animationProgress > 1) animationProgress = 0; // Loop back to start

                const pos = curve.getPointAt(animationProgress);
                const tangent = curve.getTangentAt(animationProgress).normalize();

                train.position.copy(pos);

                // Orient the train to face the path direction
                const lookAtPt = pos.clone().add(tangent);
                train.lookAt(lookAtPt);

                // OrbitControls target smoothly follows train
                controls.target.lerp(pos, 0.05);

                // Keep camera drifting loosely with train
                const cameraOffsetTarget = pos.clone().add(new THREE.Vector3(15, 10, 15));
                camera.position.lerp(cameraOffsetTarget, 0.01);

                // UI Update
                percentSpan.innerText = Math.floor(animationProgress * 100);
            }

            controls.update();
            renderer.render(scene, camera);
        }

        // Handle Window Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>